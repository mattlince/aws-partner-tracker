<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Partner Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
        }

        .logo {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin: 8px 0;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-item .icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.warning {
            border-left: 4px solid #ffc107;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.priority-high {
            border-left: 4px solid #ff4757;
            background: #fff5f5;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .metric-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .metric-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .widget {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
            margin-bottom: 24px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .widget-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .quick-action {
            padding: 12px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action:hover {
            background: #e9ecef;
        }

        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .alert-item.high-priority {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 16px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .activity-meta {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">üéØ AWS Partner Tracker</div>
            <nav>
                <div class="nav-item active" data-tab="dashboard">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-tab="contacts">
                    <span class="icon">üë•</span>
                    <span>Contacts</span>
                </div>
                <div class="nav-item" data-tab="deals">
                    <span class="icon">üí∞</span>
                    <span>Deals</span>
                </div>
                <div class="nav-item" data-tab="pipeline">
                    <span class="icon">üìà</span>
                    <span>Pipeline</span>
                </div>
                <div class="nav-item" data-tab="touchpoints">
                    <span class="icon">üìû</span>
                    <span>Touchpoints</span>
                    <div class="notification-badge" id="touchpointBadge" style="display: none;">0</div>
                </div>
                <div class="nav-item" data-tab="teams">
                    <span class="icon">üè¢</span>
                    <span>Teams</span>
                </div>
                <div class="nav-item" data-tab="relationships">
                    <span class="icon">üîó</span>
                    <span>Relationships</span>
                </div>
                <div class="nav-item" data-tab="import">
                    <span class="icon">üì§</span>
                    <span>Import Teams</span>
                </div>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="AppController.showNotificationCenter()">
                        üîî Notifications (<span id="notificationCount">0</span>)
                    </button>
                    <button class="btn btn-primary" onclick="AppController.modules.touchpoints?.showQuickAddModal()">
                        ‚ûï Quick Add
                    </button>
                </div>
            </div>
            <div class="content-area" id="contentArea">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // Global touchpoint tracking system
        window.touchpointSubscribers = new Map();
        window.touchpointData = [];

        window.subscribeTouchpoints = function(moduleId, callback) {
            window.touchpointSubscribers.set(moduleId, callback);
        };

        window.notifyTouchpointChange = function(action, touchpoint) {
            window.touchpointSubscribers.forEach(callback => {
                try {
                    callback(action, touchpoint);
                } catch (error) {
                    console.error('Error in touchpoint callback:', error);
                }
            });
        };

        window.getRecentTouchpoints = function(options = {}) {
            const { limit = 10, contactId = null, type = null, days = 7 } = options;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            
            let filtered = window.touchpointData.filter(tp => new Date(tp.date) >= cutoffDate);
            
            if (contactId) filtered = filtered.filter(tp => tp.contactId === contactId);
            if (type) filtered = filtered.filter(tp => tp.type === type);
            
            return filtered
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, limit);
        };

        window.getTouchpointStats = function(contactId = null, teamId = null) {
            let filtered = window.touchpointData;
            if (contactId) filtered = filtered.filter(tp => tp.contactId === contactId);
            if (teamId) filtered = filtered.filter(tp => tp.teamId === teamId);
            
            const now = new Date();
            const thisWeek = filtered.filter(tp => {
                const tpDate = new Date(tp.date);
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                return tpDate >= weekAgo;
            });
            
            return {
                total: filtered.length,
                thisWeek: thisWeek.length,
                lastTouchpoint: filtered.length > 0 ? 
                    filtered.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null
            };
        };

        // Enhanced Data Manager
        const DataManager = {
            data: {
                teams: {},
                contacts: {},
                deals: [],
                touchpoints: [],
                tasks: [],
                relationships: [],
                teamMembers: {},
                settings: {}
            },

            init() {
                this.loadData();
                this.setupAutoSave();
            },

            loadData() {
                try {
                    const saved = localStorage.getItem('awsPartnerTrackerData');
                    if (saved) {
                        this.data = { ...this.data, ...JSON.parse(saved) };
                    }
                    
                    // Sync with global touchpoint data
                    window.touchpointData = this.data.touchpoints || [];
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            },

            saveData() {
                try {
                    localStorage.setItem('awsPartnerTrackerData', JSON.stringify(this.data));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            },

            setupAutoSave() {
                setInterval(() => this.saveData(), 30000); // Auto-save every 30 seconds
            },

            // Contact methods
            addContact(contact) {
                contact.id = contact.id || Date.now().toString();
                contact.createdAt = contact.createdAt || new Date().toISOString();
                contact.relationshipScore = contact.relationshipScore || 5;
                contact.lastContact = contact.lastContact || new Date().toISOString();
                
                this.data.contacts[contact.id] = contact;
                this.saveData();
                return contact;
            },

            updateContact(contactId, updates) {
                if (this.data.contacts[contactId]) {
                    this.data.contacts[contactId] = { ...this.data.contacts[contactId], ...updates };
                    this.saveData();
                    return this.data.contacts[contactId];
                }
                return null;
            },

            getContact(contactId) {
                return this.data.contacts[contactId] || null;
            },

            getAllContacts() {
                return Object.values(this.data.contacts);
            },

            // Deal methods
            addDeal(deal) {
                deal.id = deal.id || Date.now().toString();
                deal.createdAt = deal.createdAt || new Date().toISOString();
                deal.stage = deal.stage || 'prospecting';
                deal.priority = deal.priority || 'medium';
                
                this.data.deals.push(deal);
                this.saveData();
                return deal;
            },

            updateDeal(dealId, updates) {
                const dealIndex = this.data.deals.findIndex(d => d.id === dealId);
                if (dealIndex !== -1) {
                    this.data.deals[dealIndex] = { ...this.data.deals[dealIndex], ...updates };
                    this.saveData();
                    return this.data.deals[dealIndex];
                }
                return null;
            },

            getDeals() {
                return this.data.deals;
            },

            // Touchpoint methods
            addTouchpoint(touchpoint) {
                touchpoint.id = touchpoint.id || Date.now().toString();
                touchpoint.date = touchpoint.date || new Date().toISOString();
                
                this.data.touchpoints.push(touchpoint);
                window.touchpointData.push(touchpoint);
                
                // Update contact's last contact date
                if (touchpoint.contactId && this.data.contacts[touchpoint.contactId]) {
                    this.data.contacts[touchpoint.contactId].lastContact = touchpoint.date;
                }
                
                this.saveData();
                window.notifyTouchpointChange('add', touchpoint);
                return touchpoint;
            }
        };

        // UI Helper Functions
        const UIHelpers = {
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'block';
                }
            },

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            },

            showNotification(message, duration = 3000, type = 'success') {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                if (typeof message === 'object') {
                    notification.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">${message.title}</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 12px;">${message.message}</div>
                        ${message.actions ? message.actions.map(action => 
                            `<button class="btn btn-sm" onclick="${action.action}; this.parentElement.remove();">${action.label}</button>`
                        ).join(' ') : ''}
                    `;
                } else {
                    notification.textContent = message;
                }

                container.appendChild(notification);

                if (duration > 0 && !message.actions) {
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, duration);
                }
            },

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            }
        };

        // Dashboard Module
        class DashboardModule {
            constructor() {
                this.refreshInterval = null;
                this.currentTimeframe = 'week';
            }

            init() {
                console.log('Dashboard module initialized');
                this.render();
                this.setupAutoRefresh();
                
                // Subscribe to touchpoint updates
                window.subscribeTouchpoints('dashboardModule', (action, touchpoint) => {
                    this.updateMetrics();
                });
            }

            render() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="quick-actions">
                        <div class="quick-action" onclick="AppController.modules.touchpoints.showQuickAddModal()">
                            üìû Log Touchpoint
                        </div>
                        <div class="quick-action" onclick="AppController.modules.deals.addDeal()">
                            üí∞ Add Deal
                        </div>
                        <div class="quick-action" onclick="AppController.modules.contacts.addContact()">
                            üë• Add Contact
                        </div>
                        <div class="quick-action" onclick="AppController.modules.dashboard.refreshData()">
                            üîÑ Refresh
                        </div>
                    </div>

                    <div class="dashboard-grid" id="metricsGrid">
                        <!-- Metrics will be loaded here -->
                    </div>

                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">‚ö†Ô∏è Priority Alerts</h3>
                        </div>
                        <div id="alertsContainer">
                            <!-- Alerts will be loaded here -->
                        </div>
                    </div>

                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üìû Recent Activity</h3>
                        </div>
                        <div id="activityContainer">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>
                `;

                this.updateMetrics();
                this.updateAlerts();
                this.updateRecentActivity();
            }

            updateMetrics() {
                const contacts = DataManager.getAllContacts();
                const deals = DataManager.getDeals();
                const touchpoints = window.getRecentTouchpoints({ days: 7 });

                const totalPipeline = deals.reduce((sum, deal) => sum + (deal.value || 0), 0);
                const closingSoon = deals.filter(deal => {
                    if (!deal.closeDate) return false;
                    const closeDate = new Date(deal.closeDate);
                    const weekFromNow = new Date();
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    return closeDate <= weekFromNow;
                }).length;

                const avgRelationshipScore = contacts.length > 0 ? 
                    contacts.reduce((sum, c) => sum + (c.relationshipScore || 5), 0) / contacts.length : 0;

                const metricsGrid = document.getElementById('metricsGrid');
                if (metricsGrid) {
                    metricsGrid.innerHTML = `
                        <div class="metric-card">
                            <div class="metric-value">${UIHelpers.formatCurrency(totalPipeline)}</div>
                            <div class="metric-label">Total Pipeline</div>
                            <div class="metric-change positive">+${deals.length} deals</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${touchpoints.length}</div>
                            <div class="metric-label">Touchpoints This Week</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${contacts.length}</div>
                            <div class="metric-label">Active Contacts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${closingSoon}</div>
                            <div class="metric-label">Closing Soon</div>
                            <div class="metric-change ${closingSoon > 0 ? 'negative' : 'positive'}">Next 7 days</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${avgRelationshipScore.toFixed(1)}</div>
                            <div class="metric-label">Avg Relationship Score</div>
                        </div>
                    `;
                }
            }

            updateAlerts() {
                const contacts = DataManager.getAllContacts();
                const deals = DataManager.getDeals();
                const alerts = [];

                // Check for stale contacts (30+ days without touchpoint)
                const staleContacts = contacts.filter(contact => {
                    const lastContact = new Date(contact.lastContact || contact.createdAt);
                    const daysSince = (new Date() - lastContact) / (1000 * 60 * 60 * 24);
                    return daysSince > 30;
                });

                if (staleContacts.length > 0) {
                    alerts.push({
                        type: 'warning',
                        message: `${staleContacts.length} contacts haven't been contacted in 30+ days`,
                        action: () => AppController.switchTab('contacts', 'stale')
                    });
                }

                // Check for overdue deals
                const overdueDeals = deals.filter(deal => {
                    if (!deal.closeDate) return false;
                    return new Date(deal.closeDate) < new Date();
                });

                if (overdueDeals.length > 0) {
                    alerts.push({
                        type: 'high-priority',
                        message: `${overdueDeals.length} deals are overdue`,
                        action: () => AppController.switchTab('deals', 'overdue')
                    });
                }

                const alertsContainer = document.getElementById('alertsContainer');
                if (alertsContainer) {
                    if (alerts.length === 0) {
                        alertsContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">‚úÖ No alerts - everything looks good!</div>';
                    } else {
                        alertsContainer.innerHTML = alerts.map(alert => `
                            <div class="alert-item ${alert.type}">
                                <span>${alert.message}</span>
                                <button class="btn btn-sm" onclick="(${alert.action})()">Review</button>
                            </div>
                        `).join('');
                    }
                }
            }

            updateRecentActivity() {
                const recentTouchpoints = window.getRecentTouchpoints({ limit: 5 });
                const activityContainer = document.getElementById('activityContainer');
                
                if (activityContainer) {
                    if (recentTouchpoints.length === 0) {
                        activityContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No recent activity</div>';
                    } else {
                        activityContainer.innerHTML = recentTouchpoints.map(tp => {
                            const contact = DataManager.getContact(tp.contactId);
                            const contactName = contact ? contact.name : 'Unknown Contact';
                            
                            return `
                                <div class="activity-item">
                                    <div class="activity-icon">üìû</div>
                                    <div class="activity-content">
                                        <div class="activity-title">${tp.type} with ${contactName}</div>
                                        <div class="activity-meta">${UIHelpers.formatDate(tp.date)} ‚Ä¢ ${tp.notes || 'No notes'}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            }

            setupAutoRefresh() {
                this.refreshInterval = setInterval(() => {
                    if (AppController.currentTab === 'dashboard') {
                        this.updateMetrics();
                        this.updateAlerts();
                        this.updateRecentActivity();
                    }
                }, 120000); // Refresh every 2 minutes
            }

            refreshData() {
                this.updateMetrics();
                this.updateAlerts();
                this.updateRecentActivity();
                UIHelpers.showNotification('Dashboard refreshed successfully!');
            }

            destroy() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }
        }

        // Simple placeholder modules for other tabs
        class ContactsModule {
            init() {
                console.log('Contacts module initialized');
            }
            
            render() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üë• Contacts</h3>
                            <button class="btn btn-primary" onclick="AppController.modules.contacts.addContact()">Add Contact</button>
                        </div>
                        <div id="contactsList">
                            ${this.renderContactsList()}
                        </div>
                    </div>
                `;
            }

            renderContactsList() {
                const contacts = DataManager.getAllContacts();
                if (contacts.length === 0) {
                    return '<div style="padding: 20px; color: #666; text-align: center;">No contacts yet. Click "Add Contact" to get started!</div>';
                }

                return contacts.map(contact => `
                    <div class="activity-item">
                        <div class="activity-icon">üë§</div>
                        <div class="activity-content">
                            <div class="activity-title">${contact.name}</div>
                            <div class="activity-meta">
                                ${contact.email || 'No email'} ‚Ä¢ 
                                Score: ${contact.relationshipScore || 5}/10 ‚Ä¢ 
                                Last Contact: ${contact.lastContact ? UIHelpers.formatDate(contact.lastContact) : 'Never'}
                            </div>
                        </div>
                        <button class="btn btn-sm" onclick="AppController.modules.contacts.logTouchpointFor('${contact.id}')">
                            üìû Log Call
                        </button>
                    </div>
                `).join('');
            }
            
            addContact() {
                const name = prompt('Contact name:');
                if (!name) return;
                
                const email = prompt('Contact email (optional):');
                const company = prompt('Company (optional):');
                const phone = prompt('Phone (optional):');
                
                const contact = DataManager.addContact({ 
                    name, 
                    email, 
                    company, 
                    phone,
                    relationshipScore: 5 
                });
                
                this.render();
                UIHelpers.showNotification(`‚úÖ Contact ${name} added successfully!`);
                
                // Update dashboard if it's the current tab
                if (AppController.currentTab === 'dashboard') {
                    AppController.modules.dashboard.updateMetrics();
                }
            }

            logTouchpointFor(contactId) {
                const contact = DataManager.getContact(contactId);
                if (!contact) {
                    UIHelpers.showNotification('Contact not found!', 3000, 'error');
                    return;
                }

                const type = prompt('Touchpoint type (call, email, meeting, other):', 'call');
                if (!type) return;

                const notes = prompt('Notes (optional):');
                const outcome = prompt('Outcome (positive, neutral, negative):', 'positive');

                const touchpoint = DataManager.addTouchpoint({
                    contactId: contactId,
                    contactName: contact.name,
                    type: type,
                    notes: notes || '',
                    outcome: outcome,
                    date: new Date().toISOString()
                });

                // Update relationship score based on outcome
                let scoreChange = 0;
                if (outcome === 'positive') scoreChange = 0.5;
                else if (outcome === 'negative') scoreChange = -0.5;

                if (scoreChange !== 0) {
                    const newScore = Math.max(1, Math.min(10, (contact.relationshipScore || 5) + scoreChange));
                    DataManager.updateContact(contactId, { relationshipScore: newScore });
                }

                this.render();
                UIHelpers.showNotification(`üìû ${type} logged with ${contact.name}!`);
            }
        }

        class DealsModule {
            init() {
                console.log('Deals module initialized');
            }
            
            render() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üí∞ Deals</h3>
                            <button class="btn btn-primary" onclick="AppController.modules.deals.addDeal()">Add Deal</button>
                        </div>
                        <div id="dealsList">
                            ${this.renderDealsList()}
                        </div>
                    </div>
                `;
            }

            renderDealsList() {
                const deals = DataManager.getDeals();
                if (deals.length === 0) {
                    return '<div style="padding: 20px; color: #666; text-align: center;">No deals yet. Click "Add Deal" to get started!</div>';
                }

                return deals.map(deal => `
                    <div class="activity-item">
                        <div class="activity-icon">üí∞</div>
                        <div class="activity-content">
                            <div class="activity-title">${deal.title}</div>
                            <div class="activity-meta">
                                ${UIHelpers.formatCurrency(deal.value || 0)} ‚Ä¢ 
                                Stage: ${deal.stage} ‚Ä¢ 
                                ${deal.closeDate ? 'Closes: ' + UIHelpers.formatDate(deal.closeDate) : 'No close date'}
                            </div>
                        </div>
                        <button class="btn btn-sm" onclick="AppController.modules.deals.updateStage('${deal.id}')">
                            Update Stage
                        </button>
                    </div>
                `).join('');
            }
            
            addDeal() {
                const title = prompt('Deal title:');
                if (!title) return;
                
                const value = prompt('Deal value (USD):');
                const stage = prompt('Stage (prospecting, qualification, proposal, negotiation, closed-won, closed-lost):', 'prospecting');
                const closeDate = prompt('Expected close date (YYYY-MM-DD):');
                
                const contacts = DataManager.getAllContacts();
                let contactId = null;
                if (contacts.length > 0) {
                    const contactNames = contacts.map(c => c.name).join(', ');
                    const selectedContact = prompt(`Associated contact (${contactNames}):`);
                    const contact = contacts.find(c => c.name.toLowerCase().includes(selectedContact?.toLowerCase() || ''));
                    if (contact) contactId = contact.id;
                }

                const deal = DataManager.addDeal({ 
                    title, 
                    value: parseFloat(value) || 0,
                    stage: stage || 'prospecting',
                    closeDate: closeDate || null,
                    contactId: contactId,
                    priority: 'medium'
                });
                
                this.render();
                UIHelpers.showNotification(`üí∞ Deal "${title}" added successfully!`);
                
                // Update dashboard if it's the current tab
                if (AppController.currentTab === 'dashboard') {
                    AppController.modules.dashboard.updateMetrics();
                }
            }

            updateStage(dealId) {
                const deal = DataManager.getDeals().find(d => d.id === dealId);
                if (!deal) return;

                const stages = ['prospecting', 'qualification', 'proposal', 'negotiation', 'closed-won', 'closed-lost'];
                const currentIndex = stages.indexOf(deal.stage);
                const stageOptions = stages.map((stage, index) => 
                    `${index + 1}. ${stage}${index === currentIndex ? ' (current)' : ''}`
                ).join('\n');

                const newStageNum = prompt(`Select new stage for "${deal.title}":\n${stageOptions}\n\nEnter number (1-${stages.length}):`);
                const newStageIndex = parseInt(newStageNum) - 1;

                if (newStageIndex >= 0 && newStageIndex < stages.length) {
                    DataManager.updateDeal(dealId, { stage: stages[newStageIndex] });
                    this.render();
                    UIHelpers.showNotification(`‚úÖ Deal stage updated to "${stages[newStageIndex]}"`);
                    
                    // Update dashboard
                    if (AppController.currentTab === 'dashboard') {
                        AppController.modules.dashboard.updateMetrics();
                    }
                }
            }
        }

        class TouchpointsModule {
            init() {
                console.log('Touchpoints module initialized');
            }
            
            render() {
                const content = document.getElementById('contentArea');
                const recentTouchpoints = window.getRecentTouchpoints({ limit: 20 });
                
                content.innerHTML = `
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üìû Touchpoints</h3>
                            <button class="btn btn-primary" onclick="AppController.modules.touchpoints.showQuickAddModal()">Log Touchpoint</button>
                        </div>
                        <div id="touchpointsList">
                            ${this.renderTouchpointsList()}
                        </div>
                    </div>
                `;
            }

            renderTouchpointsList() {
                const recentTouchpoints = window.getRecentTouchpoints({ limit: 20 });
                if (recentTouchpoints.length === 0) {
                    return '<div style="padding: 20px; color: #666; text-align: center;">No touchpoints yet. Click "Log Touchpoint" to get started!</div>';
                }

                return recentTouchpoints.map(tp => {
                    const contact = DataManager.getContact(tp.contactId);
                    const contactName = contact ? contact.name : 'Unknown Contact';
                    const typeIcon = {
                        'call': 'üìû',
                        'email': '‚úâÔ∏è', 
                        'meeting': 'ü§ù',
                        'other': 'üìù'
                    }[tp.type] || 'üìû';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">${typeIcon}</div>
                            <div class="activity-content">
                                <div class="activity-title">${tp.type} with ${contactName}</div>
                                <div class="activity-meta">
                                    ${UIHelpers.formatDate(tp.date)} ‚Ä¢ 
                                    ${tp.outcome ? `Outcome: ${tp.outcome} ‚Ä¢ ` : ''}
                                    ${tp.notes || 'No notes'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showQuickAddModal() {
                const contacts = DataManager.getAllContacts();
                if (contacts.length === 0) {
                    UIHelpers.showNotification('‚ö†Ô∏è Please add contacts first before logging touchpoints!', 3000, 'warning');
                    // Offer to add a contact first
                    if (confirm('Would you like to add a contact first?')) {
                        AppController.modules.contacts.addContact();
                    }
                    return;
                }
                
                // Show contact selection
                const contactNames = contacts.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
                const contactChoice = prompt(`Select contact:\n${contactNames}\n\nEnter number (1-${contacts.length}):`);
                const contactIndex = parseInt(contactChoice) - 1;
                
                if (contactIndex < 0 || contactIndex >= contacts.length) {
                    UIHelpers.showNotification('‚ùå Invalid contact selection', 3000, 'error');
                    return;
                }
                
                const selectedContact = contacts[contactIndex];
                this.addTouchpointFor(selectedContact.id);
            }

            addTouchpointFor(contactId) {
                const contact = DataManager.getContact(contactId);
                if (!contact) {
                    UIHelpers.showNotification('Contact not found!', 3000, 'error');
                    return;
                }

                const type = prompt('Touchpoint type:\n1. Call\n2. Email\n3. Meeting\n4. Other\n\nEnter number (1-4):', '1');
                const typeMap = { '1': 'call', '2': 'email', '3': 'meeting', '4': 'other' };
                const selectedType = typeMap[type] || 'call';

                const notes = prompt('Notes about this touchpoint:');
                const outcome = prompt('Outcome:\n1. Positive\n2. Neutral\n3. Negative\n\nEnter number (1-3):', '1');
                const outcomeMap = { '1': 'positive', '2': 'neutral', '3': 'negative' };
                const selectedOutcome = outcomeMap[outcome] || 'positive';

                const touchpoint = DataManager.addTouchpoint({
                    contactId: contactId,
                    contactName: contact.name,
                    type: selectedType,
                    notes: notes || '',
                    outcome: selectedOutcome,
                    date: new Date().toISOString()
                });

                // Update relationship score based on outcome
                let scoreChange = 0;
                if (selectedOutcome === 'positive') scoreChange = 0.5;
                else if (selectedOutcome === 'negative') scoreChange = -0.5;

                if (scoreChange !== 0) {
                    const newScore = Math.max(1, Math.min(10, (contact.relationshipScore || 5) + scoreChange));
                    DataManager.updateContact(contactId, { relationshipScore: newScore });
                    
                    if (scoreChange > 0) {
                        UIHelpers.showNotification(`üéâ Relationship score with ${contact.name} improved to ${newScore.toFixed(1)}!`);
                    }
                }

                this.render();
                UIHelpers.showNotification(`üìû ${selectedType} logged with ${contact.name}!`);
                
                // Update dashboard
                if (AppController.currentTab === 'dashboard') {
                    AppController.modules.dashboard.updateMetrics();
                    AppController.modules.dashboard.updateRecentActivity();
                }
            }

            // Legacy method name for compatibility
            addTouchpoint() {
                this.showQuickAddModal();
            }
        }

        // Simple placeholder modules
        class PipelineModule {
            init() { console.log('Pipeline module initialized'); }
            render() {
                document.getElementById('contentArea').innerHTML = `
                    <div class="widget">
                        <h3>üìà Pipeline Management</h3>
                        <p>Pipeline visualization coming soon...</p>
                    </div>
                `;
            }
        }

        class TeamsModule {
            init() { 
                console.log('Teams module initialized'); 
            }
            
            render() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üè¢ Teams & Organizations</h3>
                            <button class="btn btn-primary" onclick="AppController.modules.teams.addTeam()">Add Team</button>
                        </div>
                        <div id="teamsList">
                            ${this.renderTeamsList()}
                        </div>
                    </div>
                `;
            }

            renderTeamsList() {
                const teams = DataManager.data.teams || {};
                const teamEntries = Object.entries(teams);
                
                if (teamEntries.length === 0) {
                    return `
                        <div style="padding: 20px; color: #666; text-align: center;">
                            <p>No teams yet. Click "Add Team" to get started!</p>
                            <p style="margin-top: 12px; font-size: 14px;">
                                üí° <strong>Tip:</strong> Teams represent customer organizations you're tracking
                            </p>
                        </div>
                    `;
                }

                return teamEntries.map(([teamId, team]) => {
                    const teamContacts = DataManager.getAllContacts().filter(c => c.teamId === teamId);
                    const teamDeals = DataManager.getDeals().filter(d => d.teamId === teamId);
                    const totalValue = teamDeals.reduce((sum, deal) => sum + (deal.value || 0), 0);
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">üè¢</div>
                            <div class="activity-content">
                                <div class="activity-title">${team.name}</div>
                                <div class="activity-meta">
                                    ${teamContacts.length} contacts ‚Ä¢ 
                                    ${teamDeals.length} deals ‚Ä¢ 
                                    ${UIHelpers.formatCurrency(totalValue)} pipeline
                                    ${team.tier ? ` ‚Ä¢ Tier: ${team.tier}` : ''}
                                    ${team.geo ? ` ‚Ä¢ ${team.geo}` : ''}
                                </div>
                            </div>
                            <button class="btn btn-sm" onclick="AppController.modules.teams.viewTeamDetails('${teamId}')">
                                View Details
                            </button>
                        </div>
                    `;
                }).join('');
            }

            addTeam() {
                const name = prompt('Team/Organization name:');
                if (!name) return;

                const tier = prompt('Tier (Enterprise, Commercial, SMB):');
                const geo = prompt('Geography/Region:');
                const industry = prompt('Industry:');
                const website = prompt('Website (optional):');

                const teamId = Date.now().toString();
                const team = {
                    id: teamId,
                    name: name,
                    tier: tier || '',
                    geo: geo || '',
                    industry: industry || '',
                    website: website || '',
                    createdAt: new Date().toISOString()
                };

                if (!DataManager.data.teams) {
                    DataManager.data.teams = {};
                }
                DataManager.data.teams[teamId] = team;
                DataManager.saveData();

                this.render();
                UIHelpers.showNotification(`üè¢ Team "${name}" added successfully!`);
            }

            viewTeamDetails(teamId) {
                const team = DataManager.data.teams[teamId];
                if (!team) return;

                const teamContacts = DataManager.getAllContacts().filter(c => c.teamId === teamId);
                const teamDeals = DataManager.getDeals().filter(d => d.teamId === teamId);

                const details = `
Team: ${team.name}
${team.tier ? `Tier: ${team.tier}\n` : ''}${team.geo ? `Geography: ${team.geo}\n` : ''}${team.industry ? `Industry: ${team.industry}\n` : ''}
Contacts: ${teamContacts.length}
Deals: ${teamDeals.length}
Pipeline Value: ${UIHelpers.formatCurrency(teamDeals.reduce((sum, d) => sum + (d.value || 0), 0))}

Would you like to:
1. Add contact to this team
2. Add deal to this team
3. View team touchpoints
                `;

                const choice = prompt(details + '\n\nEnter choice (1-3):');
                
                switch(choice) {
                    case '1':
                        this.addContactToTeam(teamId);
                        break;
                    case '2':
                        this.addDealToTeam(teamId);
                        break;
                    case '3':
                        this.viewTeamTouchpoints(teamId);
                        break;
                }
            }

            addContactToTeam(teamId) {
                const team = DataManager.data.teams[teamId];
                const name = prompt(`Add contact to ${team.name}:\n\nContact name:`);
                if (!name) return;

                const email = prompt('Contact email:');
                const role = prompt('Role/Title:');
                const phone = prompt('Phone (optional):');

                const contact = DataManager.addContact({
                    name: name,
                    email: email,
                    role: role,
                    phone: phone,
                    teamId: teamId,
                    teamName: team.name
                });

                UIHelpers.showNotification(`üë§ ${name} added to ${team.name}!`);
                this.render();
            }

            addDealToTeam(teamId) {
                const team = DataManager.data.teams[teamId];
                const title = prompt(`Add deal to ${team.name}:\n\nDeal title:`);
                if (!title) return;

                const value = prompt('Deal value (USD):');
                const stage = prompt('Stage (prospecting, qualification, proposal, negotiation, closed-won, closed-lost):', 'prospecting');

                const deal = DataManager.addDeal({
                    title: title,
                    value: parseFloat(value) || 0,
                    stage: stage || 'prospecting',
                    teamId: teamId,
                    teamName: team.name
                });

                UIHelpers.showNotification(`üí∞ Deal "${title}" added to ${team.name}!`);
                this.render();
            }

            viewTeamTouchpoints(teamId) {
                const team = DataManager.data.teams[teamId];
                const teamContacts = DataManager.getAllContacts().filter(c => c.teamId === teamId);
                const contactIds = teamContacts.map(c => c.id);
                
                const teamTouchpoints = window.touchpointData.filter(tp => 
                    contactIds.includes(tp.contactId)
                );

                if (teamTouchpoints.length === 0) {
                    alert(`No touchpoints recorded for ${team.name} yet.`);
                    return;
                }

                const summary = `
${team.name} - Recent Activity:

${teamTouchpoints.slice(0, 5).map(tp => {
    const contact = DataManager.getContact(tp.contactId);
    return `‚Ä¢ ${tp.type} with ${contact?.name || 'Unknown'} (${new Date(tp.date).toLocaleDateString()})`;
}).join('\n')}

Total touchpoints: ${teamTouchpoints.length}
                `;

                alert(summary);
            }
        }

        class RelationshipsModule {
            init() { console.log('Relationships module initialized'); }
            render() {
                document.getElementById('contentArea').innerHTML = `
                    <div class="widget">
                        <h3>üîó Relationships</h3>
                        <p>Relationship mapping coming soon...</p>
                    </div>
                `;
            }
        }

        class ImportModule {
            init() { console.log('Import module initialized'); }
            render() {
                document.getElementById('contentArea').innerHTML = `
                    <div class="widget">
                        <h3>üì§ Import Teams</h3>
                        <p>Team import functionality coming soon...</p>
                    </div>
                `;
            }
        }

        // Enhanced App Controller
        const AppController = {
            modules: {},
            currentTab: 'dashboard',
            notifications: [],
            notificationInterval: null,

            init() {
                console.log('AppController initializing...');
                
                // Initialize data manager first
                DataManager.init();
                
                // Initialize all modules
                this.initializeModules();
                this.setupNavigation();
                this.setupNotificationSystem();
                this.switchTab('dashboard');
                
                console.log('‚úÖ AWS Partner Tracker initialized successfully!');
                UIHelpers.showNotification('üéâ AWS Partner Tracker loaded successfully!');
            },

            initializeModules() {
                try {
                    this.modules.dashboard = new DashboardModule();
                    this.modules.contacts = new ContactsModule();
                    this.modules.deals = new DealsModule();
                    this.modules.touchpoints = new TouchpointsModule();
                    this.modules.pipeline = new PipelineModule();
                    this.modules.teams = new TeamsModule();
                    this.modules.relationships = new RelationshipsModule();
                    this.modules.import = new ImportModule();
                    
                    // Initialize all modules
                    Object.values(this.modules).forEach(module => {
                        if (module.init) module.init();
                    });
                    
                    console.log('‚úÖ All modules initialized successfully');
                } catch (error) {
                    console.error('‚ùå Error initializing modules:', error);
                    UIHelpers.showNotification('Error initializing modules: ' + error.message, 5000, 'error');
                }
            },

            setupNavigation() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const tab = e.currentTarget.dataset.tab;
                        if (tab) this.switchTab(tab);
                    });
                });
            },

            setupNotificationSystem() {
                // Check for new alerts every 5 minutes
                this.notificationInterval = setInterval(() => {
                    this.checkForAlerts();
                }, 300000);

                // Subscribe to touchpoint changes for notifications
                window.subscribeTouchpoints('appController', (action, touchpoint) => {
                    if (action === 'add') {
                        UIHelpers.showNotification(`üìû Touchpoint logged with ${touchpoint.contactName || 'contact'}!`);
                        this.updateNotificationBadges();
                    }
                });
            },

            switchTab(tabName, subView = null) {
                console.log(`Switching to tab: ${tabName}`);
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const targetNav = document.querySelector(`[data-tab="${tabName}"]`);
                if (targetNav) {
                    targetNav.classList.add('active');
                }

                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    contacts: 'Contacts',
                    deals: 'Deals', 
                    pipeline: 'Pipeline',
                    touchpoints: 'Touchpoints',
                    teams: 'Teams',
                    relationships: 'Relationships',
                    import: 'Import Teams'
                };
                
                document.getElementById('pageTitle').textContent = titles[tabName] || 'AWS Partner Tracker';
                this.currentTab = tabName;

                // Render the appropriate module
                try {
                    if (this.modules[tabName] && this.modules[tabName].render) {
                        this.modules[tabName].render(subView);
                    } else {
                        document.getElementById('contentArea').innerHTML = `
                            <div class="loading">
                                <h3>üöß ${titles[tabName]} Module</h3>
                                <p>This module is being developed...</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`Error rendering ${tabName} module:`, error);
                    document.getElementById('contentArea').innerHTML = `
                        <div class="loading">
                            <h3>‚ùå Error Loading Module</h3>
                            <p>Failed to load ${tabName} module: ${error.message}</p>
                        </div>
                    `;
                }
            },

            checkForAlerts() {
                const contacts = DataManager.getAllContacts();
                const deals = DataManager.getDeals();
                
                // Check for high-value deals closing soon
                const highValueDeals = deals.filter(deal => {
                    if (!deal.closeDate || !deal.value) return false;
                    const closeDate = new Date(deal.closeDate);
                    const threeDaysFromNow = new Date();
                    threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
                    return closeDate <= threeDaysFromNow && deal.value > 10000;
                });

                if (highValueDeals.length > 0) {
                    UIHelpers.showNotification({
                        title: 'üö® High-Value Deals Closing Soon',
                        message: `${highValueDeals.length} high-value deals closing within 3 days`,
                        actions: [
                            { label: 'Review Now', action: () => this.switchTab('deals', 'closing-soon') }
                        ]
                    }, 0, 'priority-high');
                }
            },

            updateNotificationBadges() {
                const touchpointBadge = document.getElementById('touchpointBadge');
                const notificationCount = document.getElementById('notificationCount');
                
                // Simple notification count (could be enhanced)
                const recentTouchpoints = window.getRecentTouchpoints({ days: 1 });
                
                if (touchpointBadge) {
                    if (recentTouchpoints.length > 0) {
                        touchpointBadge.textContent = recentTouchpoints.length;
                        touchpointBadge.style.display = 'flex';
                    } else {
                        touchpointBadge.style.display = 'none';
                    }
                }
                
                if (notificationCount) {
                    notificationCount.textContent = this.notifications.length;
                }
            },

            showNotificationCenter() {
                UIHelpers.showNotification('Notification center coming soon!', 3000, 'info');
            }
        };

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Starting AWS Partner Tracker...');
            try {
                AppController.init();
            } catch (error) {
                console.error('‚ùå Failed to initialize AWS Partner Tracker:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #dc3545;">
                        <h2>‚ùå Initialization Error</h2>
                        <p>Failed to start the AWS Partner Tracker</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">üîÑ Refresh Page</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
